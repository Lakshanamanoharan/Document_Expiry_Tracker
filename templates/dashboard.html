<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Expiry Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Load FontAwesome and Chart.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-area">
                <h1><i class="fa-solid fa-layer-group"></i> Document Tracker</h1>
            </div>
            <div class="user-profile">
                <div class="user-info">
                    <i class="fa-solid fa-user-circle"></i>
                    <span>{{ current_user.username }}</span>
                </div>
                <a href="{{ url_for('settings') }}" class="logout-link" style="margin-right: 1rem;"><i
                        class="fa-solid fa-gear"></i> Settings</a>
                <a href="{{ url_for('logout') }}" class="logout-link"><i class="fa-solid fa-sign-out-alt"></i>
                    Logout</a>
                <a href="{{ url_for('add_document') }}" class="btn btn-primary">
                    <i class="fa-solid fa-plus" style="margin-right: 8px;"></i> Add Document
                </a>
            </div>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div style="margin-bottom: 2rem;">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
                <i class="fa-solid fa-circle-exclamation" style="margin-right: 8px;"></i> {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" style="color: #60a5fa;">{{ total }}</div>
                <div class="stat-label">Total Documents</div>
            </div>
            <div class="stat-card">
                <!-- Clickable stats for filtering -->
                <div class="stat-value" style="color: #ef4444;">{{ expired }}</div>
                <div class="stat-label">Expired</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #f59e0b;">{{ expiring }}</div>
                <div class="stat-label">Expiring Soon</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #10b981;">{{ compliance }}%</div>
                <div class="stat-label">Compliance Rate</div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="stats-grid" id="analyticsSection" style="margin-bottom: 3rem; display: none;">
            <div class="stat-card" style="grid-column: span 2;">
                <h3 style="margin-bottom: 1rem;"><i class="fa-solid fa-chart-pie"
                        style="margin-right: 8px; color: var(--primary);"></i> Document Distribution</h3>
                <div style="height: 250px; display: flex; justify-content: center;">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
            <div class="stat-card" style="grid-column: span 2;">
                <h3 style="margin-bottom: 1rem;"><i class="fa-solid fa-calendar-days"
                        style="margin-right: 8px; color: var(--primary);"></i> Expiry Outlook</h3>
                <div style="height: 250px; display: flex; justify-content: center;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Document List -->
        <div class="documents-section">
            <div class="section-header">
                <h2>All Documents</h2>
                <div class="filters" style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <form action="{{ url_for('dashboard') }}" method="GET" class="search-form"
                        style="display: flex; gap: 0.5rem;">
                        <input type="text" name="search" placeholder="Search documents..." value="{{ search_query }}"
                            style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                        <button type="submit" class="btn btn-primary" style="padding: 0.4rem 0.8rem;">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </button>
                    </form>
                    <div class="filter-links">
                        <a href="{{ url_for('dashboard') }}" class="btn" style="color:white; font-size:0.9rem;">All</a>
                        <a href="{{ url_for('expiring_documents') }}" class="btn"
                            style="color:#f59e0b; font-size:0.9rem;">Expiring</a>
                        <a href="{{ url_for('expired_documents') }}" class="btn"
                            style="color:#ef4444; font-size:0.9rem;">Expired</a>
                    </div>
                    <div class="bulk-actions" style="margin-left: auto; display: flex; gap: 0.5rem;">
                        <button id="toggleAnalytics" class="btn"
                            style="color: #6366f1; border: 1px solid rgba(99, 102, 241, 0.2);">
                            <i class="fa-solid fa-chart-simple"></i> Analytics
                        </button>
                        <a href="{{ url_for('export_csv') }}" class="btn"
                            style="color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <i class="fa-solid fa-file-export"></i> Export
                        </a>
                        <button id="bulkDeleteBtn" class="btn"
                            style="color: #ef4444; border: 1px solid rgba(139, 92, 246, 0.2); display: none;"
                            onclick="submitBulkDelete()">
                            <i class="fa-solid fa-trash-can"></i> Delete Selected
                        </button>
                    </div>
                </div>
            </div>

            <form id="bulkActionForm" action="{{ url_for('bulk_delete') }}" method="POST">

                {% if docs %}
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAll"></th>
                            <th>Document Name</th>
                            <th>Type</th>
                            <th>Expiry Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in docs %}
                        <tr>
                            <td><input type="checkbox" name="doc_ids" value="{{ doc['id'] }}" class="doc-checkbox"></td>
                            <td>
                                <i class="fa-regular fa-file-lines" style="margin-right:8px; color:#94a3b8;"></i>
                                <div style="display: inline-block; vertical-align: middle;">
                                    <div>{{ doc['name'] }}</div>
                                    {% if doc['tags'] %}
                                    <div style="font-size: 0.75rem; color: var(--primary); opacity: 0.8;">
                                        <i class="fa-solid fa-tags"></i> {{ doc['tags'] }}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>{{ doc['type'] }}</td>
                            <td>
                                {% if doc['expiry_date'] %}
                                {{ doc['expiry_date'] }}
                                {% else %}
                                <span style="color: #64748b;">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if doc['status'] == 'Valid' %}
                                <span class="status-badge status-valid">Valid</span>
                                {% elif doc['status'] == 'Expiring Soon' %}
                                <span class="status-badge status-expiring">Expiring Soon</span>
                                {% elif doc['status'] == 'Expired' %}
                                <span class="status-badge status-expired">Expired</span>
                                {% else %}
                                <span class="status-badge" style="background:rgba(255,255,255,0.1);">Unknown</span>
                                {% endif %}
                            </td>
                            <td>
                                <button type="button" class="btn preview-btn" style="color:#6366f1; padding:0.25rem;"
                                    data-url="{{ url_for('uploaded_file', filename=doc['filename']) }}"
                                    data-title="{{ doc['name'] }}">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                                <a href="{{ url_for('edit_document', id=doc['id']) }}" class="btn"
                                    style="color:#10b981; padding:0.25rem; margin: 0 4px;">
                                    <i class="fa-solid fa-pen"></i>
                                </a><button type="button" class="btn delete-btn" data-id="{{ doc['id'] }}"
                                    style="color:#ef4444; padding:0.25rem; background:none; border:none; cursor:pointer;">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>

            {% for doc in docs %}
            <form id="delete-form-{{doc['id']}}" action="{{ url_for('delete_document', id=doc['id']) }}" method="POST"
                style="display:none;"></form>
            {% endfor %}
            {% else %}
            <div style="text-align: center; padding: 3rem; color: #64748b;">
                <i class="fa-regular fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>No documents found. Start by adding one!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal"
        style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);">
        <div class="modal-content"
            style="background: var(--card-bg); margin: 5% auto; padding: 20px; border: var(--card-border); width: 80%; max-width: 1000px; border-radius: 1rem; position: relative;">
            <span class="close-modal"
                style="position: absolute; right: 20px; top: 10px; font-size: 28px; cursor: pointer; color: #94a3b8;"
                onclick="closePreview()">&times;</span>
            <h2 id="modalTitle" style="margin-bottom: 20px;">Document Preview</h2>
            <div id="previewContainer"
                style="height: 600px; width: 100%; background: white; border-radius: 0.5rem; overflow: hidden;">
                <iframe id="previewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- Hidden data for JS -->
    <div id="docs-data" data-docs="{{ docs | tojson | forceescape }}" style="display: none;"></div>

    <script>
        // Check for expiring documents and trigger browser notifications
        window.onload = function () {
            const dataElement = document.getElementById('docs-data');
            if (!dataElement) return;

            const docs = JSON.parse(dataElement.dataset.docs);

            // Notification logic
            const expiringSoon = docs.filter(doc => doc.status === "Expiring Soon");
            const isEnabled = localStorage.getItem("notifications_enabled") === "true";

            if (expiringSoon.length > 0 && Notification.permission === "granted" && isEnabled) {
                const count = expiringSoon.length;
                new Notification("Expiry Alert", {
                    body: `You have ${count} documents expiring within 15 days.`,
                    icon: "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/circle-exclamation.svg"
                });
            }

            // Analytics Logic
            const types = {};
            const statuses = { "Valid": 0, "Expiring Soon": 0, "Expired": 0 };
            docs.forEach(d => {
                types[d.type] = (types[d.type] || 0) + 1;
                if (statuses.hasOwnProperty(d.status)) {
                    statuses[d.status]++;
                }
            });

            new Chart(document.getElementById("typeChart"), {
                type: "doughnut",
                data: {
                    labels: Object.keys(types),
                    datasets: [{
                        data: Object.values(types),
                        backgroundColor: ["#6366f1", "#a855f7", "#10b981", "#f59e0b", "#f43f5e"],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: "bottom", labels: { color: "#94a3b8" } } }
                }
            });

            new Chart(document.getElementById("statusChart"), {
                type: "bar",
                data: {
                    labels: Object.keys(statuses),
                    datasets: [{
                        label: "Documents",
                        data: Object.values(statuses),
                        backgroundColor: ["#10b981", "#f59e0b", "#ef4444"],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: "rgba(255,255,255,0.05)" }, ticks: { color: "#94a3b8" } },
                        x: { grid: { display: false }, ticks: { color: "#94a3b8" } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        // UI Interactions
        const analyticsBtn = document.getElementById("toggleAnalytics");
        if (analyticsBtn) {
            analyticsBtn.onclick = function () {
                const section = document.getElementById("analyticsSection");
                section.style.display = section.style.display === "none" ? "grid" : "none";
                analyticsBtn.classList.toggle("active");
            };
        }

        // Bulk Selection
        const selectAll = document.getElementById("selectAll");
        const checkboxes = document.querySelectorAll(".doc-checkbox");
        const bulkBtn = document.getElementById("bulkDeleteBtn");

        if (selectAll) {
            selectAll.onchange = function () {
                checkboxes.forEach(c => c.checked = selectAll.checked);
                toggleBulkBtn();
            };
        }

        checkboxes.forEach(c => c.onchange = toggleBulkBtn);

        function toggleBulkBtn() {
            const anyChecked = Array.from(checkboxes).some(c => c.checked);
            bulkBtn.style.display = anyChecked ? "inline-flex" : "none";
        }

        function submitBulkDelete() {
            if (confirm("Delete all selected documents?")) {
                document.getElementById("bulkActionForm").submit();
            }
        }

        // --- Preview Logic ---
        document.querySelectorAll(".preview-btn").forEach(btn => {
            btn.onclick = function () {
                const url = this.getAttribute("data-url");
                const title = this.getAttribute("data-title");
                previewDocument(url, title);
            };
        });

        // --- Delete Logic ---
        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.onclick = function () {
                const id = this.getAttribute("data-id");
                if (confirm("Are you sure you want to delete this document?")) {
                    document.getElementById("delete-form-" + id).submit();
                }
            };
        });

        function previewDocument(url, title) {
            document.getElementById("modalTitle").innerText = title;
            document.getElementById("previewFrame").src = url;
            document.getElementById("previewModal").style.display = "block";
        }

        function closePreview() {
            document.getElementById("previewModal").style.display = "none";
            document.getElementById("previewFrame").src = "";
        }

        window.onclick = function (event) {
            const modal = document.getElementById("previewModal");
            if (event.target == modal) closePreview();
        }
    </script>
</body>

</html>